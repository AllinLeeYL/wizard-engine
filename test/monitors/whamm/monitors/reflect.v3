//@use lib.whamm.WhammCoModule;
//@use lib.wizeng.Wizeng;

def main() {
}

export "wasm:exit" def exit() {
	puts("Module defs:\n");
	print_defs("Type", WhammCoModule.get_num_types, WhammCoModule.read_type_def);
	print_defs("Import", WhammCoModule.get_num_imports, WhammCoModule.read_import_def);
	print_defs("Function", WhammCoModule.get_num_functions, WhammCoModule.read_function_def);
	print_defs("Table", WhammCoModule.get_num_tables, WhammCoModule.read_table_def);
	print_defs("Memory", WhammCoModule.get_num_memories, WhammCoModule.read_memory_def);
	print_defs("Global", WhammCoModule.get_num_globals, WhammCoModule.read_global_def);
	print_defs("Tag", WhammCoModule.get_num_tags, WhammCoModule.read_tag_def);
	print_defs("Export", WhammCoModule.get_num_exports, WhammCoModule.read_export_def);
	print_defs("Elem", WhammCoModule.get_num_elements, WhammCoModule.read_element_def);
	print_defs("Data", WhammCoModule.get_num_data, WhammCoModule.read_data_def);
	print_defs("Custom", WhammCoModule.get_num_custom_sections, WhammCoModule.read_custom_section);
}

def buffer = Array<byte>.new(16);

def puti = Wizeng.puti;
def puts = Wizeng.puts;
def putu(i: u32) { puti(int.!(i)); }

def print_defs(name: string, count: void -> u32, read: (Range<byte>, u32) -> u32) {
	var num = count();
	if (num == 0) return;
	puts(name);
	puts("[");
	putu(num);
	puts("]:\n");
	for (i < num) {
		puts(" - ");
		var len = read(buffer, i);
		var end = if(len > buffer.length, buffer.length, int.!(len));
		for (j < end) {
			puts(" ");
			putb(buffer[j]);
		}
		if (len > buffer.length) {
			puts("... [");
			putu(len);
			puts(" bytes]");
		}
		puts("\n");
	}
}

def hexMap_u = "0123456789ABCDEF";
def putb(b: byte) {
	wizeng.puts(Pointer.atElement(hexMap_u, b >> 4), 1);
	wizeng.puts(Pointer.atElement(hexMap_u, b & 15), 1);
}
