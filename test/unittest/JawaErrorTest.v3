// Copyright 2020 Ben L. Titzer. All rights reserved.
// See LICENSE for details of Apache 2.0 license.

def T = UnitTests.registerT(_, JawaTester.new, _);
def X = [
	T("jawa:err_reftype", test_err_reftype),
	T("jawa:err_noimm", test_err_noimm),
	()
];

def RETURN_TYPES = Arrays.prepend(JawaTypeRef.Void,
	Arrays.map<JawaPrimType, JawaTypeRef>(JawaTypes.PRIMITIVES, JawaTypeRef.Prim));

def test_err_reftype(t: JawaTester) {
	for (op in JawaFuncOpcode) {
		match (op.imm) {
			REF_TYPE, ARRAY_TYPE, CLASS_TYPE, INTERFACE_TYPE => ;
			_ => continue;
		}
		for (jt in RETURN_TYPES) {
			var n = JawaTester.new(t.t);
			var cmd = JawaAsm.new()
				.putc(op.code)
				.put_jtref(jt)
				.extract();
			var it = n.addFuncImport(cmd, SigCache.i_i); // sig doesn't matter
			n.assertProcessFails();
		}
	}
}

def test_err_noimm(t: JawaTester) {
	for (op in JawaFuncOpcode) {
		if (op.imm == JawaImmKind.NONE) continue;
		var n = JawaTester.new(t.t);
		var it = n.addFuncImport([op.code], SigCache.i_i); // sig doesn't matter
		n.assertProcessFails();
	}
	for (op in JawaTypeOpcode) {
		if (op.imm == JawaImmKind.NONE) continue;
		var n = JawaTester.new(t.t);
		var it = n.addTypeImport([op.code], []); // constraints don't matter
		n.assertProcessFails();
	}
	for (op in JawaGlobalOpcode) {
		if (op.imm == JawaImmKind.NONE) continue;
		var n = JawaTester.new(t.t);
		var it = n.addGlobalImport([op.code], ValueType.I32); // type doesn't matter
		n.assertProcessFails();
	}

}

/*
TODO AALOAD
  - not a ref array
  - improper sig
TODO AASTORE
TODO ACMPEQ
TODO ANEWARRAY
TODO ARRAYLENGTH
TODO ATHROW
TODO BALOAD
TODO BASTORE
TODO CALOAD
TODO CASTORE
TODO CHECKCAST
TODO DALOAD
TODO DASTORE
TODO DCMPG
TODO DCMPL
TODO DREM
TODO FALOAD
TODO FASTORE
TODO FCMPG
TODO FCMPL
TODO FREM
TODO GETFIELD
TODO GETSTATIC
TODO IALOAD
TODO IASTORE
TODO INSTANCEOF
TODO INVOKEDYNAMIC
TODO INVOKEINTERFACE
TODO INVOKESPECIAL
TODO INVOKESTATIC
TODO INVOKEVIRTUAL
TODO LALOAD
TODO LASTORE
TODO MONITORENTER
TODO MONITOREXIT
TODO MULTIANEWARRAY
TODO NEW
TODO NEWARRAY
TODO ISNULL
TODO PUTFIELD
TODO PUTSTATIC
TODO SALOAD
TODO SASTORE

*/
